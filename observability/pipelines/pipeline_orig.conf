# Input A: Beats (Filebeat/Winlogbeat/Metricbeat)
input {
  beats { port => 5044 }
  tcp   { port => 5001 codec => json_lines } # simple JSON over TCP (e.g., app sends logs)
  # Input B (optional): Kafka
  # kafka { bootstrap_servers => "kafka:9092" topics => ["app-logs"] codec => json }
}

filter {
  # Example: parse common app JSON logs with a 'message' and 'level' field
  mutate { add_field => { "service" => "%{[fields][service]}" "env" => "%{[fields][env]}" } }
  # Pseudonymise simple PII (demo): mask email/phone if present
  if [email] {
    mutate { gsub => ["email", "(?<=.{2}).(?=[^@]*?@)", "*"] }
  }
  if [phone] {
    mutate { gsub => ["phone", "(\\d{3})\\d+(\\d{2})", "\\1****\\2"] }
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "logs-%{[fields][service]}-%{+yyyy.MM.dd}"
  }
  # optional: debug
  # stdout { codec => rubydebug }
}
